From e77d48f3355b8d180c2fc1ab32f0fb8ba94e3a66 Mon Sep 17 00:00:00 2001
From: Marcello Seri <marcello.seri@citrix.com>
Date: Fri, 12 Jan 2018 12:23:20 +0000
Subject: [PATCH] datamodel: setup the ulimit for the opam build

Signed-off-by: Marcello Seri <marcello.seri@citrix.com>
---
 build-datamodel.sh  | 7 +++++++
 xapi-datamodel.opam | 2 +-
 2 files changed, 8 insertions(+), 1 deletion(-)
 create mode 100644 build-datamodel.sh

diff --git a/build-datamodel.sh b/build-datamodel.sh
new file mode 100644
index 000000000..024b03dad
--- /dev/null
+++ b/build-datamodel.sh
@@ -0,0 +1,7 @@
+#!/usr/bin/env bash
+set -eux
+
+# Set ulimit to avoid stack overflow when building xapi-datamodel
+ulimit -s 16432
+
+jbuilder build -p xapi-datamodel
diff --git a/xapi-datamodel.opam b/xapi-datamodel.opam
index 8ccdeea31..9bb721a04 100644
--- a/xapi-datamodel.opam
+++ b/xapi-datamodel.opam
@@ -5,7 +5,7 @@ homepage: "https://github.com/xapi-project/xen-api"
 bug-reports: "https://github.com/xapi-project/xen-api/issues"
 dev-repo: "https://github.com/xapi-project/xen-api.git"
 
-build: [[ "jbuilder" "build" "-p" name ]]
+build: [[ "bash" "build-datamodel.sh" ]]
 
 depends: [
   "jbuilder" {build & >= "1.0+beta11"}
-- 
2.14.1

