From 30008017342a46b06cd2871cfa045b895283b56d Mon Sep 17 00:00:00 2001
From: Gabor Igloi <gabor.igloi@citrix.com>
Date: Mon, 23 Oct 2017 11:18:06 +0100
Subject: [PATCH] Update to new nbd 3 library

Signed-off-by: Gabor Igloi <gabor.igloi@citrix.com>
---
 src/impl.ml   | 14 +++++++-------
 src/jbuild    |  2 +-
 vhd-tool.opam |  3 ++-
 3 files changed, 10 insertions(+), 9 deletions(-)

diff --git a/src/impl.ml b/src/impl.ml
index 634802a..c4097ea 100644
--- a/src/impl.ml
+++ b/src/impl.ml
@@ -217,8 +217,8 @@ let stream_nbd common c s prezeroed _ ?(progress = no_progress_bar) () =
       | `Sectors data ->
         Client.write server (Int64.mul sector 512L) [data] >>= begin
           function
-          | `Ok () -> return Int64.(of_int (Cstruct.len data))
-          | `Error e -> fail (Failure "Got error from NBD library")
+          | Ok () -> return Int64.(of_int (Cstruct.len data))
+          | Error e -> fail (Failure "Got error from NBD library")
         end
       | `Empty n -> (* must be prezeroed *)
         assert prezeroed;
@@ -828,8 +828,8 @@ let serve_nbd_to_raw common size c dest _ _ _ _ =
   let rec serve_requests () =
     c.Channels.really_read req >>= fun () ->
     match Request.unmarshal req with
-    | `Error e -> fail e
-    | `Ok request ->
+    | Error e -> fail e
+    | Ok request ->
       if common.Common.debug
       then Printf.fprintf stderr "%s\n%!" (Request.to_string request);
       begin match request.Request.ty with
@@ -838,17 +838,17 @@ let serve_nbd_to_raw common size c dest _ _ _ _ =
           c.Channels.really_read subblock >>= fun () ->
           Vhd_lwt.IO.really_write dest offset subblock
         ) request >>= fun () ->
-        Reply.marshal rep { Reply.error = `Ok (); handle = request.Request.handle };
+        Reply.marshal rep { Reply.error = Ok (); handle = request.Request.handle };
         c.Channels.really_write rep
       | Command.Read ->
-        Reply.marshal rep { Reply.error = `Ok (); handle = request.Request.handle };
+        Reply.marshal rep { Reply.error = Ok (); handle = request.Request.handle };
         c.Channels.really_write rep >>= fun () ->
         inblocks (fun offset subblock ->
           Vhd_lwt.IO.really_read dest offset subblock >>= fun () ->
           c.Channels.really_write subblock
         ) request
       | _ ->
-        Reply.marshal rep { Reply.error = `Error `EPERM; handle = request.Request.handle };
+        Reply.marshal rep { Reply.error = Error `EPERM; handle = request.Request.handle };
         c.Channels.really_write rep
       end >>= fun () ->
       serve_requests () in
diff --git a/src/jbuild b/src/jbuild
index 105debb..a0c399d 100644
--- a/src/jbuild
+++ b/src/jbuild
@@ -26,7 +26,7 @@ let () = Printf.ksprintf Jbuild_plugin.V1.send {|
     cstruct
     cohttp.lwt
     io-page.unix
-    nbd.lwt
+    nbd-lwt-unix
     re.str
     sha.sha1
     tapctl
diff --git a/vhd-tool.opam b/vhd-tool.opam
index 7c93a98..eb74ad2 100644
--- a/vhd-tool.opam
+++ b/vhd-tool.opam
@@ -18,7 +18,8 @@ depends: [
   "cstruct" {>= "1.0.1" & < "3.0.0"}
   "io-page-unix"
   "lwt" {>= "2.4.3" & < "3.0.0"}
-  "nbd" {>= "1.0.1" & < "3.0.0"}
+  "nbd"
+  "nbd-lwt-unix"
   "re"
   "sha"
   "ssl"
-- 
2.7.4

