From 9308e18734c696dab804fb782700d8fe412fd348 Mon Sep 17 00:00:00 2001
From: Gabor Igloi <gabor.igloi@citrix.com>
Date: Fri, 20 Oct 2017 10:54:34 +0100
Subject: [PATCH] Update to newer NBD library

Signed-off-by: Gabor Igloi <gabor.igloi@citrix.com>
Signed-off-by: Marcello Seri <marcello.seri@citrix.com>
---
 src/cleanup.ml | 14 ++++++--------
 src/jbuild     |  2 +-
 xapi-nbd.opam  |  2 +-
 3 files changed, 8 insertions(+), 10 deletions(-)

diff --git a/src/cleanup.ml b/src/cleanup.ml
index 38f71f3..c11cc87 100644
--- a/src/cleanup.ml
+++ b/src/cleanup.ml
@@ -152,14 +152,12 @@ module Block = struct
 
   let with_block filename f =
     Block.connect filename
-    >>= function
-    | `Error e -> Lwt.fail_with (Printf.sprintf "Unable to read %s: %s" filename (Nbd.Block_error_printer.to_string e))
-    | `Ok b ->
-      Runtime.with_tracking b (fun () ->
-          Lwt.finalize
-            (fun () -> f b)
-            (fun () -> Block.disconnect b)
-        )
+    >>= fun b ->
+    Runtime.with_tracking b (fun () ->
+        Lwt.finalize
+          (fun () -> f b)
+          (fun () -> Block.disconnect b)
+      )
 end
 
 module Runtime = struct
diff --git a/src/jbuild b/src/jbuild
index 4be14aa..0d7189b 100644
--- a/src/jbuild
+++ b/src/jbuild
@@ -10,7 +10,7 @@
     lwt
     lwt.unix
     mirage-block-unix
-    nbd.lwt
+    nbd-lwt-unix
     uri
     uuidm
     vbd_store
diff --git a/xapi-nbd.opam b/xapi-nbd.opam
index 220c582..6a610ce 100644
--- a/xapi-nbd.opam
+++ b/xapi-nbd.opam
@@ -12,7 +12,7 @@ depends: [
   "cmdliner"
   "lwt" {< "3.0.0"}
   "mirage-block-unix"
-  "nbd" {>= "2.0.1"}
+  "nbd-lwt-unix"
   "uri"
   "uuidm"
   "xapi-inventory"
-- 
2.14.1

