From 560fecc7d7022ad58925ac5fc5255b1a32bbbf02 Mon Sep 17 00:00:00 2001
From: Gabor Igloi <gabor.igloi@citrix.com>
Date: Fri, 20 Oct 2017 15:42:38 +0100
Subject: [PATCH] _oasis: update for Mirage 3

Signed-off-by: Gabor Igloi <gabor.igloi@citrix.com>
---
 _oasis          |  2 +-
 _tags           | 16 +++++++--------
 lib/META        |  4 ++--
 myocamlbuild.ml | 23 ++++++++++------------
 setup.ml        | 60 +++++++++++++++++++++++++--------------------------------
 5 files changed, 47 insertions(+), 58 deletions(-)

diff --git a/_oasis b/_oasis
index b7844e7..f0d70ec 100644
--- a/_oasis
+++ b/_oasis
@@ -22,7 +22,7 @@ Library vhd_lwt
   Findlibname:        lwt
   Findlibparent:      vhd
   Modules:            IO, File, Patterns_lwt, Block
-  BuildDepends:       lwt, lwt.unix, lwt.preemptive, threads, cstruct.lwt, oUnit, mirage-types.lwt
+  BuildDepends:       lwt, lwt.unix, lwt.preemptive, threads, cstruct.lwt, oUnit, mirage-types-lwt
   CSources:           odirect_stubs.c, blkgetsize64_stubs.c, lseek64_stubs.c
 
 Executable disk_to_ocaml
diff --git a/_tags b/_tags
index 0514ab3..323b1c3 100644
--- a/_tags
+++ b/_tags
@@ -1,5 +1,5 @@
 # OASIS_START
-# DO NOT EDIT (digest: 95fedb73f6ba09a9447e3ff28c81ffd3)
+# DO NOT EDIT (digest: bb6e6c89fdc74d9a557e4fdf4e9943fb)
 # Ignore VCS directories, you can use the same kind of rule outside
 # OASIS_START/STOP if you want to exclude directories that contains
 # useless stuff for the build process
@@ -36,28 +36,28 @@ true: annot, bin_annot
 <lib/*.ml{,i,y}>: pkg_lwt
 <lib/*.ml{,i,y}>: pkg_lwt.preemptive
 <lib/*.ml{,i,y}>: pkg_lwt.unix
-<lib/*.ml{,i,y}>: pkg_mirage-types.lwt
+<lib/*.ml{,i,y}>: pkg_mirage-types-lwt
 <lib/*.ml{,i,y}>: pkg_oUnit
 <lib/*.ml{,i,y}>: pkg_threads
 "lib/odirect_stubs.c": pkg_cstruct.lwt
 "lib/odirect_stubs.c": pkg_lwt
 "lib/odirect_stubs.c": pkg_lwt.preemptive
 "lib/odirect_stubs.c": pkg_lwt.unix
-"lib/odirect_stubs.c": pkg_mirage-types.lwt
+"lib/odirect_stubs.c": pkg_mirage-types-lwt
 "lib/odirect_stubs.c": pkg_oUnit
 "lib/odirect_stubs.c": pkg_threads
 "lib/blkgetsize64_stubs.c": pkg_cstruct.lwt
 "lib/blkgetsize64_stubs.c": pkg_lwt
 "lib/blkgetsize64_stubs.c": pkg_lwt.preemptive
 "lib/blkgetsize64_stubs.c": pkg_lwt.unix
-"lib/blkgetsize64_stubs.c": pkg_mirage-types.lwt
+"lib/blkgetsize64_stubs.c": pkg_mirage-types-lwt
 "lib/blkgetsize64_stubs.c": pkg_oUnit
 "lib/blkgetsize64_stubs.c": pkg_threads
 "lib/lseek64_stubs.c": pkg_cstruct.lwt
 "lib/lseek64_stubs.c": pkg_lwt
 "lib/lseek64_stubs.c": pkg_lwt.preemptive
 "lib/lseek64_stubs.c": pkg_lwt.unix
-"lib/lseek64_stubs.c": pkg_mirage-types.lwt
+"lib/lseek64_stubs.c": pkg_mirage-types-lwt
 "lib/lseek64_stubs.c": pkg_oUnit
 "lib/lseek64_stubs.c": pkg_threads
 # Executable disk_to_ocaml
@@ -68,7 +68,7 @@ true: annot, bin_annot
 <lib_test/disk_to_ocaml.{native,byte}>: pkg_lwt
 <lib_test/disk_to_ocaml.{native,byte}>: pkg_lwt.preemptive
 <lib_test/disk_to_ocaml.{native,byte}>: pkg_lwt.unix
-<lib_test/disk_to_ocaml.{native,byte}>: pkg_mirage-types.lwt
+<lib_test/disk_to_ocaml.{native,byte}>: pkg_mirage-types-lwt
 <lib_test/disk_to_ocaml.{native,byte}>: pkg_oUnit
 <lib_test/disk_to_ocaml.{native,byte}>: pkg_threads
 <lib_test/disk_to_ocaml.{native,byte}>: pkg_uuidm
@@ -85,7 +85,7 @@ true: annot, bin_annot
 <lib_test/parse_test.{native,byte}>: pkg_lwt.ppx
 <lib_test/parse_test.{native,byte}>: pkg_lwt.preemptive
 <lib_test/parse_test.{native,byte}>: pkg_lwt.unix
-<lib_test/parse_test.{native,byte}>: pkg_mirage-types.lwt
+<lib_test/parse_test.{native,byte}>: pkg_mirage-types-lwt
 <lib_test/parse_test.{native,byte}>: pkg_oUnit
 <lib_test/parse_test.{native,byte}>: pkg_threads
 <lib_test/parse_test.{native,byte}>: pkg_uuidm
@@ -100,7 +100,7 @@ true: annot, bin_annot
 <lib_test/*.ml{,i,y}>: pkg_lwt.ppx
 <lib_test/*.ml{,i,y}>: pkg_lwt.preemptive
 <lib_test/*.ml{,i,y}>: pkg_lwt.unix
-<lib_test/*.ml{,i,y}>: pkg_mirage-types.lwt
+<lib_test/*.ml{,i,y}>: pkg_mirage-types-lwt
 <lib_test/*.ml{,i,y}>: pkg_oUnit
 <lib_test/*.ml{,i,y}>: pkg_threads
 <lib_test/*.ml{,i,y}>: pkg_uuidm
diff --git a/lib/META b/lib/META
index 0047abd..6245c40 100644
--- a/lib/META
+++ b/lib/META
@@ -1,5 +1,5 @@
 # OASIS_START
-# DO NOT EDIT (digest: a88fe16c233d6b95c9eadf6aece076b2)
+# DO NOT EDIT (digest: 34edbb10205aa9801d5f01da317fe3fe)
 version = "0.8.1"
 description = ".vhd file manipulation"
 requires = "uuidm cstruct io-page cstruct.ppx"
@@ -12,7 +12,7 @@ package "lwt" (
  version = "0.8.1"
  description = ".vhd file manipulation"
  requires =
- "lwt lwt.unix lwt.preemptive threads cstruct.lwt oUnit mirage-types.lwt"
+ "lwt lwt.unix lwt.preemptive threads cstruct.lwt oUnit mirage-types-lwt"
  archive(byte) = "vhd_lwt.cma"
  archive(byte, plugin) = "vhd_lwt.cma"
  archive(native) = "vhd_lwt.cmxa"
diff --git a/myocamlbuild.ml b/myocamlbuild.ml
index bf98045..ca403b3 100644
--- a/myocamlbuild.ml
+++ b/myocamlbuild.ml
@@ -1,5 +1,5 @@
 (* OASIS_START *)
-(* DO NOT EDIT (digest: 054b793d85a4fd59b543758db8c4efe4) *)
+(* DO NOT EDIT (digest: d1be32fdab4ec4a6ef5ba3c2bc866db3) *)
 module OASISGettext = struct
 (* # 22 "src/oasis/OASISGettext.ml" *)
 
@@ -105,10 +105,7 @@ module OASISString = struct
         ok := false;
       incr str_idx
     done;
-    if !what_idx = String.length what then
-      true
-    else
-      false
+    !what_idx = String.length what
 
 
   let strip_starts_with ~what str =
@@ -131,10 +128,7 @@ module OASISString = struct
         ok := false;
       decr str_idx
     done;
-    if !what_idx = -1 then
-      true
-    else
-      false
+    !what_idx = -1
 
 
   let strip_ends_with ~what str =
@@ -440,7 +434,7 @@ module OASISExpr = struct
 end
 
 
-# 443 "myocamlbuild.ml"
+# 437 "myocamlbuild.ml"
 module BaseEnvLight = struct
 (* # 22 "src/base/BaseEnvLight.ml" *)
 
@@ -520,7 +514,7 @@ module BaseEnvLight = struct
 end
 
 
-# 523 "myocamlbuild.ml"
+# 517 "myocamlbuild.ml"
 module MyOCamlbuildFindlib = struct
 (* # 22 "src/plugins/ocamlbuild/MyOCamlbuildFindlib.ml" *)
 
@@ -746,6 +740,9 @@ module MyOCamlbuildBase = struct
 (* # 110 "src/plugins/ocamlbuild/MyOCamlbuildBase.ml" *)
 
 
+  let env_filename = Pathname.basename BaseEnvLight.default_filename
+
+
   let dispatch_combine lst =
     fun e ->
       List.iter
@@ -878,7 +875,7 @@ module MyOCamlbuildBase = struct
 end
 
 
-# 881 "myocamlbuild.ml"
+# 878 "myocamlbuild.ml"
 open Ocamlbuild_plugin;;
 let package_default =
   {
@@ -894,6 +891,6 @@ let conf = {MyOCamlbuildFindlib.no_automatic_syntax = false}
 
 let dispatch_default = MyOCamlbuildBase.dispatch_default conf package_default;;
 
-# 898 "myocamlbuild.ml"
+# 895 "myocamlbuild.ml"
 (* OASIS_STOP *)
 Ocamlbuild_plugin.dispatch dispatch_default;;
diff --git a/setup.ml b/setup.ml
index 96fa05b..aeca2bf 100644
--- a/setup.ml
+++ b/setup.ml
@@ -1,9 +1,9 @@
 (* setup.ml generated for the first time by OASIS v0.3.1 *)
 
 (* OASIS_START *)
-(* DO NOT EDIT (digest: 166f7b26f41522cf49aaa6dd4a666fd9) *)
+(* DO NOT EDIT (digest: d1dfe9e317b5a946e9c888e94252e03d) *)
 (*
-   Regenerated by OASIS v0.4.7
+   Regenerated by OASIS v0.4.10
    Visit http://oasis.forge.ocamlcore.org for more information and
    documentation about functions used in this file.
 *)
@@ -112,10 +112,7 @@ module OASISString = struct
         ok := false;
       incr str_idx
     done;
-    if !what_idx = String.length what then
-      true
-    else
-      false
+    !what_idx = String.length what
 
 
   let strip_starts_with ~what str =
@@ -138,10 +135,7 @@ module OASISString = struct
         ok := false;
       decr str_idx
     done;
-    if !what_idx = -1 then
-      true
-    else
-      false
+    !what_idx = -1
 
 
   let strip_ends_with ~what str =
@@ -658,6 +652,7 @@ module OASISContext = struct
       ignore_unknown_fields: bool;
       printf:                level -> string -> unit;
       srcfs:                 source OASISFileSystem.fs;
+      load_oasis_plugin:     string -> bool;
     }
 
 
@@ -682,6 +677,7 @@ module OASISContext = struct
         ignore_unknown_fields = false;
         printf                = printf;
         srcfs                 = new OASISFileSystem.host_fs(Sys.getcwd ());
+        load_oasis_plugin     = (fun _ -> false);
       }
 
 
@@ -3160,7 +3156,7 @@ module OASISFileUtil = struct
 end
 
 
-# 3163 "setup.ml"
+# 3159 "setup.ml"
 module BaseEnvLight = struct
 (* # 22 "src/base/BaseEnvLight.ml" *)
 
@@ -3240,7 +3236,7 @@ module BaseEnvLight = struct
 end
 
 
-# 3243 "setup.ml"
+# 3239 "setup.ml"
 module BaseContext = struct
 (* # 22 "src/base/BaseContext.ml" *)
 
@@ -5663,7 +5659,7 @@ module BaseCompat = struct
 end
 
 
-# 5666 "setup.ml"
+# 5662 "setup.ml"
 module InternalConfigurePlugin = struct
 (* # 22 "src/plugins/internal/InternalConfigurePlugin.ml" *)
 
@@ -6014,17 +6010,14 @@ module InternalInstallPlugin = struct
 
   let install =
 
-    let in_destdir =
+    let in_destdir fn =
       try
-        let destdir =
-          destdir ()
-        in
-          (* Practically speaking destdir is prepended
-           * at the beginning of the target filename
-           *)
-          fun fn -> destdir^fn
+        (* Practically speaking destdir is prepended at the beginning of the
+           target filename
+        *)
+        (destdir ())^fn
       with PropList.Not_set _ ->
-        fun fn -> fn
+        fn
     in
 
     let install_file ~ctxt ?(prepend_destdir=true) ?tgt_fn src_file envdir =
@@ -6469,7 +6462,7 @@ module InternalInstallPlugin = struct
 end
 
 
-# 6472 "setup.ml"
+# 6465 "setup.ml"
 module OCamlbuildCommon = struct
 (* # 22 "src/plugins/ocamlbuild/OCamlbuildCommon.ml" *)
 
@@ -6826,11 +6819,10 @@ module OCamlbuildDocPlugin = struct
     run_ocamlbuild ~ctxt (index_html :: run.extra_args) argv;
     List.iter
       (fun glb ->
-         BaseBuilt.register
-           ~ctxt
-           BaseBuilt.BDoc
-           cs.cs_name
-           [OASISFileUtil.glob ~ctxt (Filename.concat tgt_dir glb)])
+         match OASISFileUtil.glob ~ctxt (Filename.concat tgt_dir glb) with
+         | (_ :: _) as filenames ->
+             BaseBuilt.register ~ctxt BaseBuilt.BDoc cs.cs_name [filenames]
+         | [] -> ())
       ["*.html"; "*.css"]
 
 
@@ -6842,7 +6834,7 @@ module OCamlbuildDocPlugin = struct
 end
 
 
-# 6845 "setup.ml"
+# 6837 "setup.ml"
 module CustomPlugin = struct
 (* # 22 "src/plugins/custom/CustomPlugin.ml" *)
 
@@ -6974,7 +6966,7 @@ module CustomPlugin = struct
 end
 
 
-# 6977 "setup.ml"
+# 6969 "setup.ml"
 open OASISTypes;;
 
 let setup_t =
@@ -7219,7 +7211,7 @@ let setup_t =
                            FindlibPackage ("threads", None);
                            FindlibPackage ("cstruct.lwt", None);
                            FindlibPackage ("oUnit", None);
-                           FindlibPackage ("mirage-types.lwt", None)
+                           FindlibPackage ("mirage-types-lwt", None)
                         ];
                       bs_build_tools = [ExternalTool "ocamlbuild"];
                       bs_interface_patterns =
@@ -7704,8 +7696,8 @@ let setup_t =
           plugin_data = []
        };
      oasis_fn = Some "_oasis";
-     oasis_version = "0.4.7";
-     oasis_digest = Some "\214]\138l\017\202\179],\241%\249I\178[\150";
+     oasis_version = "0.4.10";
+     oasis_digest = Some "0\136eC\130\131\236K\024S\230dE\018\179\160";
      oasis_exec = None;
      oasis_setup_args = [];
      setup_update = false
@@ -7713,7 +7705,7 @@ let setup_t =
 
 let setup () = BaseSetup.setup setup_t;;
 
-# 7717 "setup.ml"
+# 7709 "setup.ml"
 let setup_t = BaseCompat.Compat_0_4.adapt_setup_t setup_t
 open BaseCompat.Compat_0_4
 (* OASIS_STOP *)
-- 
2.7.4

