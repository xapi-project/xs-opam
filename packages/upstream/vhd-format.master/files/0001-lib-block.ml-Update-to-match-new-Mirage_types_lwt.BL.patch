From 03b2827e9f66fa1a125d5536e963699c4597e6c2 Mon Sep 17 00:00:00 2001
From: Gabor Igloi <gabor.igloi@citrix.com>
Date: Fri, 20 Oct 2017 16:53:06 +0100
Subject: [PATCH] lib/block.ml: Update to match new Mirage_types_lwt.BLOCK
 interface

Signed-off-by: Gabor Igloi <gabor.igloi@citrix.com>
---
 _oasis       |  2 +-
 lib/block.ml | 21 +++++++++------------
 opam         |  1 +
 3 files changed, 11 insertions(+), 13 deletions(-)

diff --git a/_oasis b/_oasis
index 2cf387f..11e4a60 100644
--- a/_oasis
+++ b/_oasis
@@ -22,7 +22,7 @@ Library vhd_lwt
   Findlibname:        lwt
   Findlibparent:      vhd
   Modules:            IO, File, Patterns_lwt, Block
-  BuildDepends:       lwt, lwt.unix, lwt.preemptive, threads, cstruct.lwt, oUnit, mirage-types-lwt
+  BuildDepends:       lwt, lwt.unix, lwt.preemptive, threads, cstruct.lwt, oUnit, mirage-block, mirage-types-lwt
   CSources:           odirect_stubs.c, blkgetsize64_stubs.c, lseek64_stubs.c
 
 Executable disk_to_ocaml
diff --git a/lib/block.ml b/lib/block.ml
index 9fc6f13..7a6e494 100644
--- a/lib/block.ml
+++ b/lib/block.ml
@@ -18,20 +18,17 @@ open M
 
 type 'a io = 'a Lwt.t
 
-type error = [
-  | `Unknown of string
-  | `Unimplemented
-  | `Is_read_only
-  | `Disconnected
-]
+type error = Mirage_block.error
+
+let pp_error = Mirage_block.pp_error
+
+type write_error = Mirage_block.write_error
+
+let pp_write_error = Mirage_block.pp_write_error
 
 type page_aligned_buffer = Cstruct.t
 
-type info = {
-  read_write: bool;
-  sector_size: int;
-  size_sectors: int64;
-}
+type info = Mirage_block.info
 
 type t = {
   mutable vhd: IO.fd Vhd.F.Vhd.t option;
@@ -49,7 +46,7 @@ let connect path =
   let open Vhd.F in
   let sector_size = 512 in
   let size_sectors = Int64.div vhd.Vhd.footer.Footer.current_size 512L in
-  let info = { read_write; sector_size; size_sectors } in
+  let info = Mirage_block.{ read_write; sector_size; size_sectors } in
   let id = path in
   return ({ vhd = Some vhd; info; id })
 
diff --git a/opam b/opam
index 5028266..fd70912 100644
--- a/opam
+++ b/opam
@@ -14,6 +14,7 @@ depends: [
   "ocamlfind"
   "lwt" {>= "2.4.3"}
   "cstruct" {>= "1.9"}
+  "mirage-block"
   "mirage-types-lwt" {>= "3.0.0"}
   "ipaddr"
   "io-page"
-- 
2.7.4

